<!DOCTYPE html><html lang="ar" dir="rtl"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Word Buddy — الحفظ الذكي</title><link rel="manifest" href="manifest.webmanifest"><meta name="theme-color" content="#0b1220">
<style>
  :root{--bg:#0b1220;--card:#121a2a;--ink:#e9eefc;--muted:#93a0b4;--accent:#4f8cff;--good:#11c46a;--bad:#f05252}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Arabic','Noto Sans',Arial;background:linear-gradient(180deg,#0b1220,#0e1627);color:var(--ink)}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .card{background:var(--card);border:1px solid #22304a;border-radius:16px;padding:16px;margin:12px 0}
  select,input,button{background:#0e1729;color:var(--ink);border:1px solid #2a3b5e;border-radius:10px;padding:10px 12px}
  .big{font-size:36px;font-weight:800}.muted{color:var(--muted)}.pill{border:1px solid #2a3b5e;border-radius:999px;padding:4px 8px}
  .progress{height:10px;background:#11203d;border:1px solid #2a3b5e;border-radius:999px;overflow:hidden}.progress>div{height:10px;background:linear-gradient(90deg,var(--good),#58d6a7);width:0}
  .choice{border:1px solid #2a3b5e;border-radius:12px;padding:10px;cursor:pointer}.choice.correct{border-color:#11c46a}.choice.wrong{border-color:#f05252}
  .hidden{display:none}
  .warn{color:#ffb020}
</style></head><body>
<div class="wrap">
  <div class="row card">
    <strong>ورد بَدي — الحفظ الذكي</strong><div style="flex:1"></div>
    <select id="mode"><option value="flash">بطاقات</option><option value="mcq">اختيار من متعدد</option><option value="type">اكتب الكلمة</option><option value="listen">استمع واكتب</option><option value="review">مراجعة مكرّرة</option></select>
    <select id="levelFilter"><option value="">كل الوحدات</option></select>
    <label><input type="checkbox" id="reverse"> عكس العرض</label>
    <button id="installBtn">تثبيت</button>
    <button id="resetBtn">تصفير</button>
  </div>

  <div class="row card">
    <div style="flex:1">
      <div class="muted">التقدّم</div>
      <div class="progress"><div id="progressBar"></div></div>
      <div style="margin-top:6px"><span id="knownCount">0</span>/<span id="totalCount">0</span> متعلّمة</div>
    </div>
    <div class="pill" id="todayDue">0 مستحق اليوم</div>
  </div>

  <section id="nofile" class="card">
    <div class="warn">⚠️ لا يوجد ملف <code>data.json</code>. ارفع ملفك بجانب <code>index.html</code>.</div>
    <div class="muted" style="margin-top:6px">صيغة كل عنصر: {"word": "...", "meaning": "...", "example": "", "level": "Units X"}</div>
  </section>

  <section id="flash" class="card hidden">
    <div class="big" id="flashWord">—</div>
    <div class="muted" id="flashMeaning" style="margin-top:6px">—</div>
    <div class="muted" id="flashExample" style="margin-top:6px"></div>
    <div style="margin-top:8px"><span id="flashLevel" class="pill"></span> <span id="star" style="cursor:pointer">☆</span></div>
    <div class="row" style="margin-top:8px">
      <button id="speakBtn">🔊 نطق</button><button id="showBtn">إظهار</button><button id="easyBtn">سهل ✅</button><button id="hardBtn">صعب ❗</button><button id="nextBtn">التالي ▶</button>
    </div>
  </section>

  <section id="mcq" class="card hidden">
    <div class="muted" id="mcqPrompt">اختر المعنى الصحيح</div>
    <div class="big" id="mcqStem">—</div>
    <div id="mcqChoices" class="row"></div>
  </section>

  <section id="type" class="card hidden">
    <div class="muted">اكتب الكلمة الصحيحة</div>
    <div class="big" id="typePrompt">—</div>
    <input id="typeInput" placeholder="اكتب هنا..." autocomplete="off">
    <div id="typeFeedback" style="margin-top:6px"></div>
  </section>

  <section id="listen" class="card hidden">
    <div class="muted">استمع واكتب الكلمة</div>
    <button id="listenPlay">🔊 تشغيل</button>
    <input id="listenInput" placeholder="اكتب ما سمعت...">
    <div id="listenFeedback" style="margin-top:6px"></div>
  </section>

  <section id="review" class="card hidden">
    <div class="muted">كلمات للمراجعة</div>
    <div id="reviewList"></div>
  </section>
</div>

<script>
const byId=id=>document.getElementById(id); const shuffle=a=>a.sort(()=>Math.random()-0.5); function sample(a,n){return shuffle(a.slice()).slice(0,n);}
function speak(t){ if(!window.speechSynthesis) return; const u=new SpeechSynthesisUtterance(t); const v=speechSynthesis.getVoices().find(v=>/en-/i.test(v.lang)); if(v) u.voice=v; speechSynthesis.speak(u); }

let RAW_DATA=[];
fetch('data.json').then(r=>{ if(!r.ok) throw new Error('no data'); return r.json(); })
.then(d=>{RAW_DATA=d; byId('nofile').classList.add('hidden'); init();})
.catch(()=>{ byId('nofile').classList.remove('hidden'); });

const key='wordbuddy_progress_v1'; const state=JSON.parse(localStorage.getItem(key)||'{}'); const now=()=>new Date().toISOString();
function ensureState(r){ if(!state[r.word]) state[r.word]={srs:0,known:false,starred:false,due:now(),tries:0}; return state[r.word]; }
function save(){ localStorage.setItem(key, JSON.stringify(state)); refreshStats(); }

const DATA=[];
function rebuildData(){
  const ds = RAW_DATA.map((r,i)=>({id:i,word:String(r.word||'').trim(),meaning:String(r.meaning||'').trim(),example:String(r.example||'').trim(),level:String(r.level||'').trim()})).filter(r=>r.word);
  DATA.length=0; ds.forEach(x=>DATA.push(x));
  const sel=byId('levelFilter'); sel.innerHTML=''; const o=document.createElement('option'); o.value=''; o.textContent='كل الوحدات'; sel.appendChild(o);
  [...new Set(DATA.map(d=>d.level).filter(Boolean))].forEach(l=>{ const x=document.createElement('option'); x.value=l; x.textContent=l; sel.appendChild(x); });
}

function currentPool(){ const lvl=byId('levelFilter').value; return DATA.filter(d=>(!lvl||d.level===lvl)); }

function refreshStats(){
  byId('totalCount').textContent = DATA.length;
  const known = DATA.filter(d => (ensureState(d).srs)>=1).length; // known after first success
  byId('knownCount').textContent = known;
  byId('progressBar').style.width = (DATA.length? (known/DATA.length*100):0) + '%';
  const due = DATA.filter(d=> new Date(ensureState(d).due)<=new Date()).length;
  byId('todayDue').textContent = due + ' مستحق اليوم';
}

function markResult(rec, ease){
  const st=ensureState(rec);
  if(ease==='easy') st.srs=Math.min(5,(st.srs||0)+1);
  if(ease==='hard') st.srs=Math.max(0,(st.srs||0)-1);
  st.known = st.srs>=1;
  const days=[0,1,3,7,14,30][st.srs];
  const next=new Date(); next.setDate(next.getDate()+days); st.due=next.toISOString(); st.tries=0; save();
}

// Flash
let flashIdx=0, pool=[], currentRec=null;
function setFlash(r){ byId('flashWord').textContent = byId('reverse').checked ? (r.meaning||'—') : r.word; byId('flashMeaning').textContent = byId('reverse').checked ? r.word : (r.meaning||'—'); byId('flashExample').textContent = r.example?('“'+r.example+'”'):''; byId('flashLevel').textContent=r.level||''; ensureState(r); byId('star').textContent = state[r.word].starred?'★':'☆'; byId('flashMeaning').style.filter='blur(6px)'; }
function nextFlash(){ if(pool.length===0) pool=shuffle(currentPool()); const r=pool[flashIdx%pool.length]; flashIdx++; setFlash(r); return r; }
function flashInit(){ pool=shuffle(currentPool()); currentRec=nextFlash(); }

// MCQ (reveal after 2 wrong)
function setupMCQ(){
  const s=sample(currentPool(),4); if(s.length<4) return;
  const answer=s[0];
  byId('mcqStem').textContent = byId('reverse').checked ? (answer.meaning||'—') : answer.word;
  byId('mcqPrompt').textContent = byId('reverse').checked ? 'اختر الكلمة الصحيحة' : 'اختر المعنى الصحيح';
  const area=byId('mcqChoices'); area.innerHTML='';
  let wrongs=0;
  shuffle(s.map(r=>({rec:r,label: byId('reverse').checked?r.word:(r.meaning||'—')}))).forEach(c=>{
    const div=document.createElement('div'); div.className='choice'; div.textContent=c.label;
    div.onclick=()=>{ if(c.rec===answer){ div.classList.add('correct'); markResult(answer,'easy'); setTimeout(setupMCQ,600);} else { div.classList.add('wrong'); wrongs++; if(wrongs>=2){ alert('الإجابة: '+(byId('reverse').checked?answer.word:(answer.meaning||'—'))); markResult(answer,'hard'); setTimeout(setupMCQ,300);} } };
    area.appendChild(div);
  });
}

// Type (hint + reveal)
let typeRec=null;
function setupType(){ const s=currentPool(); if(!s.length) return; typeRec=s[Math.floor(Math.random()*s.length)]; byId('typePrompt').textContent = byId('reverse').checked ? (typeRec.meaning||'—') : typeRec.meaning || '—'; byId('typeInput').value=''; byId('typeFeedback').textContent=''; ensureState(typeRec).tries=0; }
byId('typeInput').addEventListener('keydown', e=>{
  if(e.key==='Enter'){ const st=ensureState(typeRec); const val=e.target.value.trim().toLowerCase(); const ans=(byId('reverse').checked?typeRec.meaning:typeRec.word).toLowerCase();
    if(val===ans){ byId('typeFeedback').textContent='ممتاز ✅'; markResult(typeRec,'easy'); setupType(); }
    else{ st.tries=(st.tries||0)+1; if(st.tries===1){ const n=Math.max(2,Math.ceil(ans.length*0.3)); byId('typeFeedback').textContent='تلميح: '+ans.slice(0,n)+'…'; }
          else { byId('typeFeedback').textContent='الإجابة: '+(byId('reverse').checked?typeRec.meaning:typeRec.word); markResult(typeRec,'hard'); setTimeout(setupType,800); } }
  }
});

// Listen
let listenRec=null;
function setupListen(){ const s=currentPool(); if(!s.length) return; listenRec=s[Math.floor(Math.random()*s.length)]; byId('listenInput').value=''; byId('listenFeedback').textContent=''; }
byId('listenPlay').onclick=()=>{ if(listenRec) speak(listenRec.word); };
byId('listenInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ const val=e.target.value.trim().toLowerCase(); const ans=listenRec.word.toLowerCase(); if(val===ans){ byId('listenFeedback').textContent='صحيح ✅'; markResult(listenRec,'easy'); setupListen(); } else { byId('listenFeedback').textContent='ليست دقيقة'; markResult(listenRec,'hard'); } } });

// Review
function renderReview(){ const due=currentPool().filter(r=> new Date(ensureState(r).due)<=new Date()); const box=byId('reviewList'); box.innerHTML=''; if(!due.length){ box.textContent='لا يوجد مراجعة الآن'; return;} due.slice(0,60).forEach(r=>{ ensureState(r); const div=document.createElement('div'); div.className='card'; div.innerHTML=`<div style="font-weight:700">${r.word}</div><div class="muted" style="margin-top:6px">${r.meaning||'—'}</div><div style="margin-top:6px" class="pill">${r.level||''}</div><div class="row" style="margin-top:8px"><button class="btn" data-e="hard">أعد</button><button class="btn" data-e="easy">سهل</button></div>`; div.querySelectorAll('button').forEach(b=>b.onclick=()=>{markResult(r,b.dataset.e); renderReview();}); box.appendChild(div); }); }

// Mode switch
const sections=['flash','mcq','type','listen','review'].map(id=>byId(id));
function setMode(m){ sections.forEach(s=>s.classList.add('hidden')); byId(m).classList.remove('hidden'); if(m==='mcq')setupMCQ(); if(m==='type')setupType(); if(m==='listen')setupListen(); if(m==='review')renderReview(); }

// Install
let deferredPrompt=null; window.addEventListener('beforeinstallprompt',e=>{ e.preventDefault(); deferredPrompt=e; byId('installBtn').disabled=false; });
byId('installBtn').onclick=async()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; };

function bind(){
  byId('resetBtn').onclick=()=>{ localStorage.removeItem(key); location.reload(); };
  byId('mode').addEventListener('change', e=> setMode(e.target.value));
  byId('levelFilter').addEventListener('change', ()=>{ flashInit(); if(byId('mode').value==='mcq')setupMCQ(); if(byId('mode').value==='review')renderReview(); });
  byId('reverse').addEventListener('change', ()=>{ flashInit(); if(byId('mode').value==='mcq')setupMCQ(); if(byId('mode').value==='type')setupType(); });
  byId('showBtn').onclick=()=>{ byId('flashMeaning').style.filter='none'; };
  byId('nextBtn').onclick=()=>{ currentRec=nextFlash(); };
  byId('easyBtn').onclick=()=>{ if(currentRec) markResult(currentRec,'easy'); currentRec=nextFlash(); };
  byId('hardBtn').onclick=()=>{ if(currentRec) markResult(currentRec,'hard'); currentRec=nextFlash(); };
  byId('speakBtn').onclick=()=>{ if(currentRec) speak(byId('reverse').checked?currentRec.meaning:currentRec.word); };
  byId('star').onclick=()=>{ const st=ensureState(currentRec); st.starred=!st.starred; byId('star').textContent=st.starred?'★':'☆'; save(); };
}

function init(){ rebuildData(); bind(); refreshStats(); setMode('type'); flashInit(); if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js'); }
</script></body></html>
